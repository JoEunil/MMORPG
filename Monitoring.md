# Monitoring 시스템 구현

## 1. 개요
이 문서는 모니터링 시스템의 구조와 지표 수집 방법에 대해 설명한다.

## 2. 목적
[구조화 로그](StructuredLogging.md)를 활용하여 TPS, 접속자 수, 지연 시간 등 핵심 성능 지표를 실시간으로 추적하고,
그 데이터를 통해 적절한 자원 할당과 병목 구간 파악을 수행하여 안정적인 서버 운영을 가능하게 한다.

- 에러 로그와 같은 일반 로그가 아닌, 서버 성능 지표 자체를 위한 별도의 로그를 대상으로 한다.
 

## 3. 로그 처리 과정
모니터링을 위한 성능 지표는 일반 로그와 분리하여 다음과 같은 흐름으로 처리된다.

1. 애플리케이션 레벨 수집기
- 서버 내부에 성능 지표 수집기(collector)를 두고  
  전용 스레드가 주기적으로 TPS, 세션 수, 큐 길이 등을 구조화 로그 형태로 기록한다.
- 로그는 사전에 정의된 로컬 경로에 저장된다.  
2. Promtail 수집기
- 로컬 파일 시스템의 변경을 감지하고 새로추가된 로그를 읽는다.
- 해당 로그를 Loki로 전송한다.
3. Loki (로그 저장소)
- 전송된 구조화 로그를 시계열 기반으로 저장한다.
- Label 기반 검색 및 필터링 기능을 제공한다.
4. Grafana 시각화
- Loki에 대해 쿼리를 수행하여 원하는 지표를 가져온다.
- 대시보드에서 실시간 그래프를 구성한다.

![이미지 로드 실패](images/monitoring.png)
> Grafana 대시보드


## 4. TPS 측정 방식
게임 서버의 Zone Thread는 시간 기반 로직 처리가 핵심이며, 일정한 TPS를 유지하는 것이 매우 중요하다.  
시간 기반 처리 요소:
- 스킬 스케줄링
- 쿨타임 감소
- HP/MP 등 자원 회복 로직
- 버프/디버프 지속 시간 처리
- AI Tick 등

 
서버 TPS가 떨어지면:
- 스킬 반응이 느려지고,
- 쿨타임이 비정상적으로 작동하며,
- 몬스터 AI가 느려지거나 틱이 밀리는 현상이 발생한다.

따라서 TPS는 Zone Thread의 건강 상태를 나타내는 핵심 지표이며
다음과 같은 방식으로 측정한다.
- zone thread에서 collector에 매 틱 counter 메서드를 수행한다.
- collector에서 1초에 한번씩 수집된 counter를 로그로 남기고 0으로 초기화한다.
	- 현재까지 집계된 Tick Count(TPS 값)를 로그로 기록한다.
	- 기록 후 Counter 값을 0으로 초기화한다.
	- 이후 1초 동안 Sleep하여 다음 측정을 대기한다.
	
__정확도 및 오차__
- Collector가 로그 기록 후 1초 Sleep을 수행하기 때문에,
  실제 1초 기준과 완전히 일치하지 않아 소폭의 오차가 발생한다.
- 이에 따라 TPS 값은 보통 19 ~ 21 범위에서 측정된다.
## 5. 참고 자료
[NetPerfCollector](NetLibrary/NetPerfCollector.h)  
[CorePerfCollector](CoreLib/CorePerfCollector.h)  
